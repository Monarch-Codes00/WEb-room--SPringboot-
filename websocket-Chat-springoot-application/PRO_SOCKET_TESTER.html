<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro WebSocket Tester - Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: #0f172a;
        color: #e2e8f0;
        font-family: "Inter", sans-serif;
      }
      .log-entry {
        margin-bottom: 5px;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.85rem;
      }
      .sent {
        background: #1e293b;
        border-left: 4px solid #3b82f6;
      }
      .received {
        background: #1e293b;
        border-left: 4px solid #10b981;
      }
      .error {
        background: #450a0a;
        border-left: 4px solid #ef4444;
      }
    </style>
  </head>
  <body class="p-8">
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Connection Pane -->
      <div
        class="lg:col-span-1 border border-slate-700 rounded-xl p-6 bg-slate-900 shadow-2xl"
      >
        <h2 class="text-xl font-bold mb-4 text-white">Connection</h2>
        <input
          id="url"
          type="text"
          value="wss://chat-backend-joc9.onrender.com/ws"
          class="w-full bg-slate-800 border-slate-700 rounded p-2 mb-4 text-sm outline-none focus:border-blue-500"
        />
        <div class="flex gap-2 mb-6">
          <button
            id="btnConnect"
            onclick="connect()"
            class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded font-semibold transition"
          >
            Connect
          </button>
          <button
            id="btnDisconnect"
            onclick="disconnect()"
            class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded font-semibold transition disabled:opacity-50"
            disabled
          >
            Disconnect
          </button>
        </div>

        <h2 class="text-xl font-bold mb-4 text-white">Feature Quick-Actions</h2>
        <div class="grid grid-cols-1 gap-2">
          <input
            id="username"
            type="text"
            placeholder="Username"
            value="Tester_1"
            class="bg-slate-800 border-slate-700 rounded p-2 text-sm"
          />
          <button
            onclick="sendMsg('LOGIN', { username: val('username') })"
            class="bg-blue-600 hover:bg-blue-700 py-2 rounded text-sm transition"
          >
            1. Register (Login)
          </button>

          <div class="flex gap-2 mt-2">
            <select
              id="roomSelect"
              class="bg-slate-800 border-slate-700 rounded p-2 text-sm flex-1"
            >
              <option value="general">General</option>
              <option value="tech">Technology</option>
              <option value="random">Random</option>
            </select>
            <button
              onclick="
                sendMsg('JOIN', {
                  username: val('username'),
                  roomId: val('roomSelect'),
                })
              "
              class="bg-purple-600 hover:bg-purple-700 px-4 rounded text-sm transition"
            >
              2. Join Room
            </button>
          </div>

          <textarea
            id="msgContent"
            placeholder="Chat message..."
            class="bg-slate-800 border-slate-700 rounded p-2 text-sm h-20 mt-2"
          ></textarea>
          <button
            onclick="
              sendMsg('CHAT', {
                username: val('username'),
                roomId: val('roomSelect'),
                content: val('msgContent'),
              })
            "
            class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded text-sm transition font-bold"
          >
            3. Send Broadcast
          </button>

          <hr class="border-slate-800 my-4" />

          <button
            onclick="sendMsg('ONLINE_USERS', { username: val('username') })"
            class="bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs transition"
          >
            Poll: All Online Users
          </button>
          <button
            onclick="
              sendMsg('ROOM_PRESENCE', {
                username: val('username'),
                roomId: val('roomSelect'),
              })
            "
            class="bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs transition"
          >
            Poll: Room Members
          </button>
        </div>
      </div>

      <!-- Log Pane -->
      <div
        class="lg:col-span-2 flex flex-col h-[80vh] border border-slate-700 rounded-xl bg-slate-900 shadow-2xl"
      >
        <div
          class="p-4 border-b border-slate-800 flex justify-between items-center"
        >
          <h2 class="text-xl font-bold text-white">Live Socket Stream</h2>
          <div id="statusIndicator" class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <span class="text-xs uppercase tracking-widest text-slate-400"
              >Disconnected</span
            >
          </div>
        </div>
        <div id="logs" class="flex-1 overflow-y-auto p-4 space-y-2">
          <div class="text-center text-slate-500 italic mt-20">
            Waiting for connection...
          </div>
        </div>
        <div
          class="p-2 bg-slate-950 border-t border-slate-800 text-[10px] text-slate-600 text-center"
        >
          Spring Boot WebSocket Pro Test Environment
        </div>
      </div>
    </div>

    <script>
      let socket = null;
      let heartbeat = null;

      const val = (id) => document.getElementById(id).value;
      const logBox = document.getElementById("logs");

      function log(msg, type = "received") {
        if (logBox.children.length > 50) logBox.firstChild.remove();
        const div = document.createElement("div");
        div.className = `log-entry ${type}`;
        const time = new Date().toLocaleTimeString();
        div.innerHTML = `<span class="text-slate-500">[${time}]</span> <span class="text-blue-400 font-bold">${type.toUpperCase()}:</span> ${typeof msg === "object" ? JSON.stringify(msg, null, 2) : msg}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
      }

      function connect() {
        const url = val("url");
        socket = new WebSocket(url);

        socket.onopen = () => {
          log("CONNECTION ESTABLISHED", "sent");
          updateStatus(true);
          // Start heartbeat to keep Render alive
          heartbeat = setInterval(() => {
            sendMsg("PING", { username: val("username") });
          }, 30000);
        };

        socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            log(data, "received");
          } catch (e) {
            log(event.data, "received");
          }
        };

        socket.onclose = () => {
          log("CONNECTION CLOSED", "error");
          updateStatus(false);
          clearInterval(heartbeat);
        };

        socket.onerror = (e) => {
          log("SOCKET ERROR: Check URL and CORS settings", "error");
        };
      }

      function disconnect() {
        if (socket) socket.close();
      }

      function sendMsg(type, payload) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          alert("Please connect first!");
          return;
        }
        const msg = { type, ...payload };
        socket.send(JSON.stringify(msg));
        log(msg, "sent");
      }

      function updateStatus(connected) {
        const indicator = document.getElementById("statusIndicator");
        indicator.children[0].className = `w-3 h-3 rounded-full ${connected ? "bg-green-500 animate-pulse" : "bg-red-500"}`;
        indicator.children[1].innerText = connected
          ? "Connected"
          : "Disconnected";
        document.getElementById("btnConnect").disabled = connected;
        document.getElementById("btnDisconnect").disabled = !connected;
      }
    </script>
  </body>
</html>
